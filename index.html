<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>سبحة إلكترونية متطورة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      /* الألوان الأساسية - ثيم أخضر */
      --primary: #2e7d32;
      --secondary: #ff9800;
      --accent: #2196f3;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --bg: #f8fafc;
      --text: #2d3748;
      --card-bg: #ffffff;
      --border-color: #e2e8f0;
      --gradient: linear-gradient(135deg, #4caf50, #a5d6a7);
      --solid-bg: #4caf50;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition-slow: 0.6s ease;
      --transition-fast: 0.3s ease;
    }

    /* ثيم أزرق */
    [data-theme="blue"] {
      --primary: #0288d1;
      --secondary: #ffb74d;
      --accent: #64b5f6;
      --success: #029ae5;
      --gradient: linear-gradient(135deg, #0288d1, #b3e5fc);
      --solid-bg: #0288d1;
      --bg: #f0f8ff;
      --text: #2c5282;
    }

    /* ثيم بنفسجي */
    [data-theme="purple"] {
      --primary: #9c27b0;
      --secondary: #ce93d8;
      --accent: #ba68c8;
      --success: #ab47bc;
      --gradient: linear-gradient(135deg, #9c27b0, #ce93d8);
      --solid-bg: #9c27b0;
      --bg: #faf5ff;
      --text: #6b46c1;
    }

    /* ثيم برتقالي */
    [data-theme="orange"] {
      --primary: #ff9800;
      --secondary: #ffcc80;
      --accent: #ffb74d;
      --success: #ffa726;
      --gradient: linear-gradient(135deg, #ff9800, #ffcc80);
      --solid-bg: #ff9800;
      --bg: #fffaf0;
      --text: #dd6b20;
    }

    /* ثيم وردي */
    [data-theme="pink"] {
      --primary: #e91e63;
      --secondary: #f48fb1;
      --accent: #f06292;
      --success: #ec407a;
      --gradient: linear-gradient(135deg, #e91e63, #f48fb1);
      --solid-bg: #e91e63;
      --bg: #fff5f7;
      --text: #d53f8c;
    }

    /* ثيم أزرق داكن */
    [data-theme="dark-blue"] {
      --primary: #1e3a8a;
      --secondary: #60a5fa;
      --accent: #3b82f6;
      --success: #2563eb;
      --gradient: linear-gradient(135deg, #1e3a8a, #60a5fa);
      --solid-bg: #1e3a8a;
      --bg: #eff6ff;
      --text: #1e40af;
    }

    body {
      background: var(--bg);
      font-family: 'Cairo', sans-serif;
      text-align: center;
      padding: 20px;
      color: var(--text);
      transition: all var(--transition-slow);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background-attachment: fixed;
    }

    body.dark {
      --bg: #121212;
      --text: #e2e8f0;
      --card-bg: #1e1e1e;
      --border-color: #2d3748;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--primary);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 1.1rem;
      color: var(--text);
      opacity: 0.8;
      margin-bottom: 30px;
    }

    /* دائرة التسبيح - تصميم متطور */
    .circle-container {
      position: relative;
      margin: 30px auto;
      width: 250px;
      height: 250px;
    }

    .circle {
      position: relative;
      width: 100%;
      height: 100%;
      cursor: pointer;
      background: var(--gradient);
      border-radius: 50%;
      box-shadow: var(--shadow), 0 0 0 4px rgba(255, 255, 255, 0.1) inset;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      
      /* منع المربع الأزرق والتحديد */
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      outline: none;
      tap-highlight-color: transparent;
    }

    .circle:active {
      transform: scale(0.95);
      box-shadow: 0 0 0 4px var(--primary), var(--shadow);
    }

    .circle::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      transition: transform 0.6s, opacity 0.6s;
    }

    .circle:active::after {
      transform: translate(-50%, -50%) scale(1.1);
      opacity: 1;
    }

    .circle svg {
      width: 200px;
      height: 200px;
    }

    .circle text {
      font-size: 2.5rem;
      font-weight: 700;
      fill: white;
      dominant-baseline: middle;
      text-anchor: middle;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .circle .tasbih-text {
      font-size: 1rem;
      fill: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }

    /* شريط التقدم */
    .progress-ring {
      transition: all var(--transition-fast);
    }

    /* الإحصائيات */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 30px auto;
      max-width: 600px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      border: 2px solid var(--border-color);
      transition: all var(--transition-fast);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text);
      opacity: 0.8;
    }

    /* الأزرار - تصميم متطور */
    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin: 30px auto;
      max-width: 800px;
    }

    .btn {
      padding: 16px 20px;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
      
      /* منع التحديد */
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary), #ffd54f);
      color: white;
    }

    .btn-accent {
      background: linear-gradient(135deg, var(--accent), #90caf9);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #66bb6a);
      color: white;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    /* مستوى المستخدم */
    .level-badge {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 12px 25px;
      border-radius: 25px;
      font-weight: 700;
      box-shadow: var(--shadow);
      margin: 20px auto;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    /* الإشعارات */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--success), var(--primary));
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .notification.show {
      transform: translateX(0);
    }

    /* الكونفيتي */
    .confetti {
      position: fixed;
      width: 12px;
      height: 12px;
      animation: confettiFall 3s ease-in-out forwards;
      z-index: 999;
      border-radius: 50%;
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(-100vh) rotate(0deg) scale(0);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg) scale(1);
        opacity: 0;
      }
    }

    /* تأثيرات الـ glow */
    .glow {
      animation: glowPulse 2s ease-in-out infinite;
    }

    @keyframes glowPulse {
      0%, 100% {
        box-shadow: 0 0 20px var(--primary), 0 0 0 4px rgba(255, 255, 255, 0.1) inset;
      }
      50% {
        box-shadow: 0 0 40px var(--secondary), 0 0 0 4px rgba(255, 255, 255, 0.2) inset;
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .circle-container {
        width: 200px;
        height: 200px;
      }
      
      .circle svg {
        width: 160px;
        height: 160px;
      }
      
      .circle text {
        font-size: 2rem;
      }
      
      .buttons-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .btn {
        padding: 14px 16px;
        font-size: 0.9rem;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.8rem;
      }
      
      .circle-container {
        width: 180px;
        height: 180px;
      }
      
      .buttons-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
    /* تحسينات الوضع الداكن */
body.dark {
  --bg: #1a202c;
  --text: #e2e8f0;
  --card-bg: #2d3748;
  --border-color: #4a5568;
}

body.dark .stat-card {
  background: #2d3748;
  border: 2px solid #4a5568;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
}

body.dark .stat-card:hover {
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
}

body.dark .btn {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
}

body.dark .btn:hover {
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
}

body.dark .theme-panel,
body.dark .achievements-panel,
body.dark .settings-panel {
  background: #2d3748;
  border: 2px solid #4a5568;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
}

body.dark .level-badge {
  background: linear-gradient(135deg, #2d3748, #4a5568);
  border: 2px solid #4a5568;
}

/* تحسينات عامة للواجهة */
.buttons-grid {
  margin: 20px auto;
}

/* إصلاح مشكلة الزووم على iOS */
@media screen and (max-width: 768px) {
  input, select, textarea {
    font-size: 16px !important;
  }
}

/* منع highlight على العناصر */
* {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
}

/* تحسينات المساعد */
#assistantPanel {
  backdrop-filter: blur(10px);
  border: 1px solid var(--border-color);
}

body.dark #assistantPanel {
  background: linear-gradient(135deg, #2d3748, #4a5568);
}

  </style>
</head>
<body data-theme="green">
  <div class="container">
    <div class="header">
      <h1>📿 سبحة إلكترونية متطورة</h1>
      <div class="subtitle">تسبيح رقمي بتجربة فريدة</div>
    </div>

    <div class="circle-container">
      <div class="circle" id="circle">
        <svg width="200" height="200" viewBox="0 0 200 200">
          <circle cx="100" cy="100" r="90" stroke="#e2e8f0" stroke-width="12" fill="none"/>
          <circle id="progress" cx="100" cy="100" r="90" stroke="white" stroke-width="12" fill="none"
                  stroke-dasharray="565.48" stroke-dashoffset="565.48" transform="rotate(-90 100 100)"
                  class="progress-ring"/>
          <text x="100" y="90" id="countText">0</text>
          <text x="100" y="110" id="tasbihText" class="tasbih-text">سبحان الله</text>
        </svg>
      </div>
    </div>

    <div class="level-badge">
      <i class="fas fa-star"></i>
      <span>المستوى: <span id="userLevel">1</span></span>
      <span>•</span>
      <span>النقاط: <span id="userPoints">0</span></span>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="dailyCount">0</div>
        <div class="stat-label">اليوم</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="weeklyCount">0</div>
        <div class="stat-label">الأسبوع</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalCount">0</div>
        <div class="stat-label">الإجمالي</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="elapsedTime">0:00</div>
        <div class="stat-label">الوقت</div>
      </div>
    </div>

    <div class="buttons-grid">
      <button class="btn btn-primary" id="resetBtn">
        <i class="fas fa-undo"></i> تصفير
      </button>
      <button class="btn btn-secondary" id="themeBtn">
        <i class="fas fa-palette"></i> الثيم
      </button>
      <button class="btn btn-accent" id="soundBtn">
        <i class="fas fa-volume-up"></i> صوت
      </button>
      <button class="btn btn-success" id="kineticBtn">
        <i class="fas fa-hand-rock"></i> كينوي
      </button>
      <button class="btn btn-primary" id="achievementsBtn">
        <i class="fas fa-trophy"></i> إنجازات
      </button>
      <button class="btn btn-secondary" id="settingsBtn">
        <i class="fas fa-cog"></i> إعدادات
      </button>
    </div>
    <!-- لوحة اختيار الثيمات -->
<div class="theme-panel" id="themePanel" style="display: none; margin: 30px auto; padding: 25px; background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow);">
  <h3 style="margin-bottom: 20px; color: var(--primary);">🎨 اختر المظهر</h3>
  <div class="themes-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px;">
    <div class="theme-option" data-theme="green" style="background: linear-gradient(135deg, #4caf50, #a5d6a7); padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; color: white; font-weight: bold; border: 3px solid transparent; transition: all 0.3s ease;">
      أخضر 🌿
    </div>
    <div class="theme-option" data-theme="blue" style="background: linear-gradient(135deg, #0288d1, #b3e5fc); padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; color: white; font-weight: bold; border: 3px solid transparent; transition: all 0.3s ease;">
      أزرق 🌊
    </div>
    <div class="theme-option" data-theme="purple" style="background: linear-gradient(135deg, #9c27b0, #ce93d8); padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; color: white; font-weight: bold; border: 3px solid transparent; transition: all 0.3s ease;">
      بنفسجي 💜
    </div>
    <div class="theme-option" data-theme="orange" style="background: linear-gradient(135deg, #ff9800, #ffcc80); padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; color: white; font-weight: bold; border: 3px solid transparent; transition: all 0.3s ease;">
      برتقالي 🍊
    </div>
    <div class="theme-option" data-theme="pink" style="background: linear-gradient(135deg, #e91e63, #f48fb1); padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; color: white; font-weight: bold; border: 3px solid transparent; transition: all 0.3s ease;">
      وردي 🌸
    </div>
    <div class="theme-option" data-theme="dark-blue" style="background: linear-gradient(135deg, #1e3a8a, #60a5fa); padding: 20px; border-radius: 15px; cursor: pointer; text-align: center; color: white; font-weight: bold; border: 3px solid transparent; transition: all 0.3s ease;">
      أزرق داكن 🌌
    </div>
  </div>
</div>

<!-- لوحة الإنجازات -->
<div class="achievements-panel" id="achievementsPanel" style="display: none; margin: 30px auto; padding: 25px; background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow);">
  <h3 style="margin-bottom: 20px; color: var(--primary);">🏆 الإنجازات</h3>
  <div id="achievementsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
    <!-- سيتم ملؤها بالكود -->
  </div>
</div>

<!-- الوضع الكينوي -->
<div class="kinetic-mode" id="kineticMode" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;">
  <div style="font-size: 3rem; margin-bottom: 20px;">📱</div>
  <div class="kinetic-circle" style="width: 120px; height: 120px; border: 4px solid var(--secondary); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; margin-bottom: 20px; animation: pulse 2s infinite;">
    <span id="kineticCount">0</span>
  </div>
  <div style="font-size: 1.2rem; margin-bottom: 10px;">هز الهاتف للعد</div>
  <div style="font-size: 1rem; opacity: 0.8; margin-bottom: 30px;">الحساسية: <span id="sensitivity">5</span></div>
  <div style="display: flex; gap: 15px; margin-bottom: 20px;">
    <button onclick="adjustSensitivity(-1)" style="padding: 10px 20px; background: var(--secondary); color: white; border: none; border-radius: 10px; cursor: pointer;">
      - حساسية
    </button>
    <button onclick="adjustSensitivity(1)" style="padding: 10px 20px; background: var(--secondary); color: white; border: none; border-radius: 10px; cursor: pointer;">
      + حساسية
    </button>
  </div>
  <button onclick="exitKineticMode()" style="padding: 12px 30px; background: var(--danger); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1rem;">
    <i class="fas fa-times"></i> خروج
  </button>
</div>

<!-- الإعدادات المتقدمة -->
<div class="settings-panel" id="settingsPanel" style="display: none; margin: 30px auto; padding: 25px; background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow);">
  <h3 style="margin-bottom: 20px; color: var(--primary);">⚙️ الإعدادات</h3>
  <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
    <div class="setting-group">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">نوع التسبيح:</label>
      <select id="tasbihType" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg); color: var(--text); font-size: 1rem;">
        <option value="33" data-text="سبحان الله">سبحان الله (33)</option>
        <option value="33" data-text="الحمد لله">الحمد لله (33)</option>
        <option value="34" data-text="الله أكبر">الله أكبر (34)</option>
        <option value="100" data-text="تسبيح عام">تسبيح عام (100)</option>
      </select>
    </div>

    <div class="setting-group">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">الحد المخصص:</label>
      <input type="number" id="alertLimit" value="33" min="10" max="1000" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg); color: var(--text); font-size: 1rem;">
    </div>

    <div class="setting-group">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">نوع الصوت:</label>
      <select id="soundType" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg); color: var(--text); font-size: 1rem;">
        <option value="keyboard" data-freq="600">كيبورد ⌨️</option>
        <option value="light" data-freq="800">نقرة خفيفة 🔔</option>
        <option value="deep" data-freq="400">نقرة عميقة 🥁</option>
      </select>
    </div>

    <div class="setting-group">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">اللغة:</label>
      <select id="language" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 10px; background: var(--bg); color: var(--text); font-size: 1rem;">
        <option value="ar">العربية 🇸🇦</option>
        <option value="en">English 🇺🇸</option>
      </select>
    </div>
  </div>
  
  <button id="saveSettingsBtn" style="margin-top: 25px; padding: 15px 30px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1rem; font-weight: 600; width: 100%;">
    <i class="fas fa-save"></i> حفظ الإعدادات
  </button>
</div>

<!-- الإشعارات -->
<div class="notification" id="notification">
  <span id="notificationText"></span>
</div>

<script>
  // الكود الأساسي والمتغيرات
  let count = 0;
  let limit = 33;
  let soundOn = true;
  let tasbihText = "سبحان الله";
  let dailyCount = 0;
  let weeklyCount = 0;
  let totalCount = 0;
  let soundFreq = 600;
  let startTime = null;
  let language = "ar";
  let audioContext = null;
  let history = JSON.parse(localStorage.getItem("tasbihHistory")) || [];
  let userLevel = 1;
  let userPoints = 0;
  let currentTheme = "green";
  
  // متغيرات الوضع الكينوي
  let kineticCount = 0;
  let kineticActive = false;
  let lastShakeTime = 0;
  let shakeThreshold = 5;
  let kineticTimer = null;

  // نظام الإنجازات
  const achievementsData = [
    {
      id: 1,
      name: "المبتدئ",
      description: "أكمل 100 تسبيحة",
      target: 100,
      points: 10,
      medal: "🥉",
      unlocked: false
    },
    {
      id: 2,
      name: "المثابر", 
      description: "أكمل 500 تسبيحة",
      target: 500,
      points: 25,
      medal: "🥈",
      unlocked: false
    },
    {
      id: 3,
      name: "المنتج",
      description: "أكمل 1000 تسبيحة", 
      target: 1000,
      points: 50,
      medal: "🥇",
      unlocked: false
    },
    {
      id: 4,
      name: "المتواصل",
      description: "تسبيح لمدة 7 أيام متتالية",
      target: 7,
      points: 30,
      medal: "📅",
      unlocked: false
    },
    {
      id: 5,
      name: "المحترف",
      description: "أكمل 5000 تسبيحة",
      target: 5000,
      points: 100,
      medal: "🏆",
      unlocked: false
    }
  ];

  const translations = {
    ar: {
      title: "📿 سبحة إلكترونية متطورة",
      reset: "تصفير",
      theme: "الثيم",
      soundOn: "صوت",
      soundOff: "صامت",
      kinetic: "كينوي",
      achievements: "إنجازات",
      settings: "إعدادات",
      daily: "اليوم",
      weekly: "الأسبوع", 
      total: "الإجمالي",
      time: "الوقت",
      level: "المستوى",
      points: "النقاط"
    },
    en: {
      title: "📿 Advanced Digital Tasbih", 
      reset: "Reset",
      theme: "Theme",
      soundOn: "Sound",
      soundOff: "Mute",
      kinetic: "Kinetic",
      achievements: "Achievements",
      settings: "Settings",
      daily: "Daily",
      weekly: "Weekly",
      total: "Total", 
      time: "Time",
      level: "Level",
      points: "Points"
    }
  };

  // دالة التهيئة
  function initializeApp() {
    loadUserData();
    setupEventListeners();
    updateUI();
    startTimer();
    updateAchievementsDisplay();
  }

  function loadUserData() {
    // تحميل البيانات من localStorage
    count = parseInt(localStorage.getItem("count")) || 0;
    totalCount = parseInt(localStorage.getItem("totalCount")) || 0;
    dailyCount = parseInt(localStorage.getItem("dailyCount")) || 0;
    weeklyCount = parseInt(localStorage.getItem("weeklyCount")) || 0;
    userLevel = parseInt(localStorage.getItem("userLevel")) || 1;
    userPoints = parseInt(localStorage.getItem("userPoints")) || 0;
    currentTheme = localStorage.getItem("currentTheme") || "green";
    
    // تطبيق الثيم
    document.body.setAttribute("data-theme", currentTheme);
    
    // تحميل الإنجازات
    const savedAchievements = localStorage.getItem("achievements");
    if (savedAchievements) {
      achievements = JSON.parse(savedAchievements);
    } else {
      achievements = achievementsData.map(ach => ({...ach}));
    }

    // التحقق من التاريخ اليومي
    const today = new Date().toDateString();
    const savedDate = localStorage.getItem("tasbihDate");
    if (savedDate !== today) {
      dailyCount = 0;
      localStorage.setItem("tasbihDate", today);
    }
  }

  function setupEventListeners() {
    // الأزرار الرئيسية
    document.getElementById("circle").addEventListener("click", handleCircleClick);
    document.getElementById("resetBtn").addEventListener("click", resetCounter);
    document.getElementById("themeBtn").addEventListener("click", toggleThemePanel);
    document.getElementById("soundBtn").addEventListener("click", toggleSound);
    document.getElementById("kineticBtn").addEventListener("click", startKineticMode);
    document.getElementById("achievementsBtn").addEventListener("click", toggleAchievementsPanel);
    document.getElementById("settingsBtn").addEventListener("click", toggleSettingsPanel);
    document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

    // منتقي الثيمات
    document.querySelectorAll(".theme-option").forEach(option => {
      option.addEventListener("click", () => changeTheme(option.dataset.theme));
    });

    // مستشعر الهز للوضع الكينوي
    if (window.DeviceMotionEvent) {
      window.addEventListener('devicemotion', handleDeviceMotion);
    }

    // إعدادات التسبيح
    document.getElementById("tasbihType").addEventListener("change", updateTasbihSettings);
    document.getElementById("soundType").addEventListener("change", updateSoundSettings);
    document.getElementById("language").addEventListener("change", updateLanguageSettings);
  }

  function updateUI() {
    // تحديث الواجهة الرئيسية
    document.getElementById("countText").textContent = count;
    document.getElementById("tasbihText").textContent = tasbihText;
    document.getElementById("dailyCount").textContent = dailyCount;
    document.getElementById("weeklyCount").textContent = weeklyCount;
    document.getElementById("totalCount").textContent = totalCount;
    document.getElementById("userLevel").textContent = userLevel;
    document.getElementById("userPoints").textContent = userPoints;
    
    // تحديث شريط التقدم
    updateProgress();
    
    // تحديث نص الأزرار
    updateButtonText();
  }

  function updateProgress() {
    const circumference = 2 * Math.PI * 90;
    const percent = (count % limit) / limit;
    const offset = circumference - (percent * circumference);
    
    const progressCircle = document.getElementById("progress");
    if (progressCircle) {
      progressCircle.style.strokeDashoffset = offset;
      
      // تغيير لون الشريط حسب النسبة
      const hue = 120 - (percent * 120); // من أخضر إلى أحمر
      progressCircle.style.stroke = `hsl(${hue}, 80%, 60%)`;
    }
  }
  function handleCircleClick() {
  count++;
  dailyCount++;
  weeklyCount++;
  totalCount++;
  
  // منح نقطة لكل تسبيحة
  userPoints++;
  
  // حفظ البيانات
  saveUserData();
  
  // تحديث الواجهة
  updateUI();
  
  // تشغيل الصوت
  if (soundOn) {
    playBeep();
  }
  
  // التحقق من إكمال الدائرة
  if (count % limit === 0 && count > 0) {
    handleCircleCompletion();
  }
  
  // التحقق من الإنجازات
  checkAchievements();
  
  // تحديث المستوى
  updateLevel();
}

function playBeep() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.type = 'sine';
  oscillator.frequency.setValueAtTime(soundFreq, audioContext.currentTime);
  gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.start();
  oscillator.stop(audioContext.currentTime + 0.05);
}

function handleCircleCompletion() {
  // تأثير بصري
  const circle = document.getElementById("circle");
  circle.classList.add("glow");
  
  // إضافة للسجل
  history.push({
    date: new Date().toLocaleDateString(),
    count: count,
    duration: document.getElementById("elapsedTime").textContent,
    type: tasbihText
  });
  
  // حفظ السجل
  localStorage.setItem("tasbihHistory", JSON.stringify(history));
  
  // إشعار
  showNotification(`🎉 أكملت ${count} تسبيحة!`, 3000);
  
  // مؤثرات بصرية
  createConfetti();
  
  // إزالة التأثير بعد فترة
  setTimeout(() => {
    circle.classList.remove("glow");
  }, 1500);
}

function createConfetti() {
  const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b'];
  
  for (let i = 0; i < 25; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
      confetti.style.animationDelay = (Math.random() * 1) + 's';
      document.body.appendChild(confetti);
      
      setTimeout(() => confetti.remove(), 3000);
    }, i * 50);
  }
}

function resetCounter() {
  count = 0;
  startTime = Date.now();
  saveUserData();
  updateUI();
  showNotification("🔄 تم تصفير العداد", 2000);
}

function toggleThemePanel() {
  const panel = document.getElementById("themePanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
  
  // إخفاء اللوحات الأخرى
  document.getElementById("achievementsPanel").style.display = "none";
  document.getElementById("settingsPanel").style.display = "none";
}

function changeTheme(theme) {
  currentTheme = theme;
  document.body.setAttribute("data-theme", theme);
  localStorage.setItem("currentTheme", theme);
  
  // تحديث تأثير الحدود على الثيم المختار
  document.querySelectorAll('.theme-option').forEach(option => {
    option.style.borderColor = option.dataset.theme === theme ? 'var(--primary)' : 'transparent';
  });
  
  showNotification(`🎨 تم تطبيق الثيم ${getThemeName(theme)}`, 2000);
}

function getThemeName(theme) {
  const themeNames = {
    'green': 'الأخضر',
    'blue': 'الأزرق',
    'purple': 'البنفسجي',
    'orange': 'البرتقالي',
    'pink': 'الوردي',
    'dark-blue': 'الأزرق الداكن'
  };
  return themeNames[theme] || theme;
}

function toggleSound() {
  soundOn = !soundOn;
  saveUserData();
  updateButtonText();
  showNotification(
    soundOn ? 
    "🔊 الصوت مفعل" : "🔇 الصوت معطل", 
    2000
  );
}

function updateButtonText() {
  const soundBtn = document.getElementById("soundBtn");
  if (soundBtn) {
    soundBtn.innerHTML = soundOn ? 
      '<i class="fas fa-volume-up"></i> صوت' : 
      '<i class="fas fa-volume-mute"></i> صامت';
  }
}

function startKineticMode() {
  const kineticMode = document.getElementById("kineticMode");
  kineticMode.style.display = "flex";
  kineticActive = true;
  kineticCount = 0;
  document.getElementById("kineticCount").textContent = "0";
  
  showNotification("📱 هز الهاتف للعد! الحساسية: " + shakeThreshold, 3000);
  
  // بدء计时器 للوضع الكينوي
  kineticTimer = setInterval(() => {
    if (kineticActive) {
      document.getElementById("kineticCount").textContent = kineticCount;
    }
  }, 100);
}

function exitKineticMode() {
  const kineticMode = document.getElementById("kineticMode");
  kineticMode.style.display = "none";
  kineticActive = false;
  
  if (kineticTimer) {
    clearInterval(kineticTimer);
  }
  
  // إضافة التسبيحات إلى العد الرئيسي
  if (kineticCount > 0) {
    count += kineticCount;
    dailyCount += kineticCount;
    weeklyCount += kineticCount;
    totalCount += kineticCount;
    userPoints += kineticCount;
    
    saveUserData();
    updateUI();
    showNotification(`🎯 أضفت ${kineticCount} تسبيحة بالهز!`, 3000);
    
    // التحقق من الإنجازات
    checkAchievements();
    updateLevel();
  }
}

function handleDeviceMotion(event) {
  if (!kineticActive) return;
  
  const acceleration = event.accelerationIncludingGravity;
  if (!acceleration) return;
  
  const currentTime = new Date().getTime();
  const timeDiff = currentTime - lastShakeTime;
  
  if (timeDiff > 200) { // منع الهز المتكرر السريع
    const x = acceleration.x;
    const y = acceleration.y;
    const z = acceleration.z;
    
    const accelerationMagnitude = Math.sqrt(x * x + y * y + z * z);
    
    if (accelerationMagnitude > shakeThreshold) {
      kineticCount++;
      lastShakeTime = currentTime;
      
      // تأثير مرئي عند الهز
      const kineticCircle = document.querySelector('.kinetic-circle');
      if (kineticCircle) {
        kineticCircle.style.transform = "scale(1.2)";
        setTimeout(() => {
          kineticCircle.style.transform = "scale(1)";
        }, 200);
      }
      
      // صوت عند الهز
      if (soundOn) {
        playBeep();
      }
    }
  }
}

function adjustSensitivity(amount) {
  shakeThreshold = Math.max(3, Math.min(15, shakeThreshold + amount));
  document.getElementById("sensitivity").textContent = shakeThreshold;
  showNotification(`📊 حساسية الهز: ${shakeThreshold}`, 2000);
}

function toggleAchievementsPanel() {
  const panel = document.getElementById("achievementsPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
  
  // إخفاء اللوحات الأخرى
  document.getElementById("themePanel").style.display = "none";
  document.getElementById("settingsPanel").style.display = "none";
  
  updateAchievementsDisplay();
}

function toggleSettingsPanel() {
  const panel = document.getElementById("settingsPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
  
  // إخفاء اللوحات الأخرى
  document.getElementById("themePanel").style.display = "none";
  document.getElementById("achievementsPanel").style.display = "none";
}

function updateTasbihSettings() {
  const select = document.getElementById("tasbihType");
  const selectedOption = select.options[select.selectedIndex];
  
  limit = parseInt(selectedOption.value);
  tasbihText = selectedOption.dataset.text;
  
  showNotification(`📿 تم التغيير إلى: ${tasbihText}`, 2000);
}

function updateSoundSettings() {
  const select = document.getElementById("soundType");
  const selectedOption = select.options[select.selectedIndex];
  
  soundFreq = parseInt(selectedOption.dataset.freq);
  showNotification(`🔊 صوت: ${selectedOption.text}`, 2000);
}

function updateLanguageSettings() {
  const select = document.getElementById("language");
  language = select.value;
  
  showNotification(
    language === "ar" ? 
    "🇸🇦 تم التغيير إلى العربية" : "🇺🇸 Changed to English", 
    2000
  );
}

function saveSettings() {
  // حفظ جميع الإعدادات
  updateTasbihSettings();
  updateSoundSettings();
  updateLanguageSettings();
  
  saveUserData();
  showNotification("✅ تم حفظ الإعدادات بنجاح", 2000);
}

function startTimer() {
  startTime = startTime || Date.now();
  
  setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    const timeElement = document.getElementById("elapsedTime");
    if (timeElement) {
      timeElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }
  }, 1000);
}

function saveUserData() {
  localStorage.setItem("count", count);
  localStorage.setItem("dailyCount", dailyCount);
  localStorage.setItem("weeklyCount", weeklyCount);
  localStorage.setItem("totalCount", totalCount);
  localStorage.setItem("userLevel", userLevel);
  localStorage.setItem("userPoints", userPoints);
  localStorage.setItem("achievements", JSON.stringify(achievements));
  localStorage.setItem("soundOn", soundOn);
  localStorage.setItem("soundFreq", soundFreq);
  localStorage.setItem("language", language);
  localStorage.setItem("limit", limit);
  localStorage.setItem("tasbihText", tasbihText);
}

function showNotification(message, duration = 3000) {
  const notification = document.getElementById("notification");
  const notificationText = document.getElementById("notificationText");
  
  if (notification && notificationText) {
    notificationText.textContent = message;
    notification.classList.add("show");
    
    setTimeout(() => {
      notification.classList.remove("show");
    }, duration);
  }
}

// نظام الإنجازات
function checkAchievements() {
  let newAchievements = false;
  
  achievements.forEach(achievement => {
    if (!achievement.unlocked) {
      let unlocked = false;
      
      switch(achievement.id) {
        case 1: // 100 تسبيحة
          unlocked = totalCount >= achievement.target;
          break;
        case 2: // 500 تسبيحة
          unlocked = totalCount >= achievement.target;
          break;
        case 3: // 1000 تسبيحة
          unlocked = totalCount >= achievement.target;
          break;
        case 4: // 7 أيام متتالية
          unlocked = checkConsecutiveDays() >= achievement.target;
          break;
        case 5: // 5000 تسبيحة
          unlocked = totalCount >= achievement.target;
          break;
      }
      
      if (unlocked) {
        achievement.unlocked = true;
        userPoints += achievement.points;
        showAchievementPopup(achievement);
        newAchievements = true;
      }
    }
  });
  
  if (newAchievements) {
    saveUserData();
    updateUI();
  }
}

function checkConsecutiveDays() {
  // تبسيط للعرض - يمكن تطويره لاحقاً
  return dailyCount > 0 ? 1 : 0;
}

function showAchievementPopup(achievement) {
  const popup = document.createElement('div');
  popup.className = 'achievement-popup';
  popup.style.background = `linear-gradient(135deg, var(--primary), var(--secondary))`;
  popup.innerHTML = `
    <div style="font-size: 4rem; margin-bottom: 1rem;">${achievement.medal}</div>
    <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem;">مبروك! 🎉</h3>
    <p style="margin: 0.5rem 0; font-size: 1.1rem;">${achievement.name}</p>
    <p style="margin: 0.5rem 0; font-size: 0.9rem; opacity: 0.9;">${achievement.description}</p>
    <p style="margin: 1rem 0 0 0; font-size: 1.2rem; font-weight: bold;">+${achievement.points} نقطة</p>
  `;
  
  document.body.appendChild(popup);
  createConfetti();
  
  setTimeout(() => popup.remove(), 5000);
}

function updateLevel() {
  const newLevel = Math.floor(userPoints / 100) + 1;
  
  if (newLevel > userLevel) {
    userLevel = newLevel;
    showNotification(`🎊 مستوى جديد! أنت الآن في المستوى ${userLevel}`, 4000);
    createConfetti();
    saveUserData();
  }
}
      function updateAchievementsDisplay() {
        const grid = document.getElementById("achievementsGrid");
        if (!grid) return;
        
        grid.innerHTML = '';
        
        achievements.forEach(achievement => {
          let progress = 0;
          switch(achievement.id) {
            case 1: case 2: case 3: case 5:
              progress = Math.min((totalCount / achievement.target) * 100, 100);
              break;
            case 4:
              progress = Math.min((checkConsecutiveDays() / achievement.target) * 100, 100);
              break;
          }
          
          const card = document.createElement('div');
          card.style.background = achievement.unlocked ? 
            `linear-gradient(135deg, var(--primary), var(--secondary))` : 'var(--card-bg)';
          card.style.padding = '20px';
          card.style.borderRadius = '15px';
          card.style.textAlign = 'center';
          card.style.border = `3px solid ${achievement.unlocked ? 'gold' : 'var(--border-color)'}`;
          card.style.transition = 'all 0.3s ease';
          card.style.cursor = 'pointer';
          
          card.innerHTML = `
            <div style="font-size: 2.5rem; margin-bottom: 10px;">${achievement.medal}</div>
            <h4 style="margin: 10px 0; color: ${achievement.unlocked ? 'white' : 'var(--text)'}; font-size: 1.1rem;">
              ${achievement.name}
            </h4>
            <p style="font-size: 0.9rem; margin: 5px 0; color: ${achievement.unlocked ? 'rgba(255,255,255,0.9)' : 'var(--text)'}; opacity: 0.8;">
              ${achievement.description}
            </p>
            <div style="background: ${achievement.unlocked ? 'rgba(255,255,255,0.3)' : 'var(--border-color)'}; 
                  height: 8px; border-radius: 4px; margin: 15px 0;">
              <div style="background: ${achievement.unlocked ? 'white' : 'var(--primary)'}; 
                    height: 100%; width: ${progress}%; border-radius: 4px; transition: width 0.5s ease;"></div>
            </div>
            <span style="font-size: 0.85rem; color: ${achievement.unlocked ? 'white' : 'var(--text)'};">
              ${achievement.unlocked ? '🏆 مكتمل' : `${Math.round(progress)}% مكتمل`}
            </span>
            ${achievement.unlocked ? `
              <div style="margin-top: 10px; font-size: 0.8rem; color: gold;">
                +${achievement.points} نقطة
              </div>
            ` : ''}
          `;
          
          grid.appendChild(card);
        });
      }

      // التحديات الموسمية
      function checkSeasonalChallenges() {
        const now = new Date();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        
        // رمضان (الشهر 9)
        if (month === 9) {
          showNotification("", 5000);
        }
        
        // العشر الأواخر (أيام 21-30 من رمضان)
        if (month === 9 && day >= 21 && day <= 30) {
          showNotification("⭐ أيام العشر الأواخر! اغتنم هذه الأيام المباركة", 5000);
        }
      }

      // المساعد الذكي (بدون إنترنت)
      function initializeAssistant() {
        // إضافة مساعد تلقائي بعد 5 ثواني
        setTimeout(() => {
          showAssistantMessage("مرحباً! أنا مساعدك الذكي للتسبيح. سأقدم لك نصائح وتذكيرات مفيدة.");
        }, 5000);
        
        // رسائل تلقائية كل دقيقة
        setInterval(() => {
          if (Math.random() < 0.3) { // 30% chance
            showRandomAssistantMessage();
          }
        }, 60000);
      }

      function showRandomAssistantMessage() {
        const messages = [
          "💡 تذكر: التسبيح في الجمعة له أجر مضاعف",
          "🌅 أفضل أوقات التسبيح: بعد صلاة الفجر",
          "🎯 حاول تحقيق هدفك اليومي قبل المغرب",
          "⭐ الاستمرارية في التسبيح تزيد البركة",
          "🤲 ادع الله بعد كل تسبيحة فهو وقت مستجاب",
          "📿 جرب أنواع مختلفة من التسبيح للتنوع",
          "🌙 في الليل يكون التركيز أعلى والأجر أكبر",
          "🙏 التسبيح يطهر القلب ويجلب الراحة"
        ];
        
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        showAssistantMessage(randomMessage);
      }

      function showAssistantMessage(message) {
        // إنشاء عنصر المساعد
        let assistant = document.getElementById('assistant');
        if (!assistant) {
          assistant = document.createElement('div');
          assistant.id = 'assistant';
          assistant.style.position = 'fixed';
          assistant.style.bottom = '20px';
          assistant.style.right = '20px';
          assistant.style.background = 'linear-gradient(135deg, var(--primary), var(--accent))';
          assistant.style.color = 'white';
          assistant.style.padding = '15px 20px';
          assistant.style.borderRadius = '15px';
          assistant.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
          assistant.style.zIndex = '999';
          assistant.style.maxWidth = '300px';
          assistant.style.transform = 'translateX(100%)';
          assistant.style.transition = 'transform 0.5s ease';
          assistant.style.cursor = 'pointer';
          assistant.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="font-size: 1.2rem;">🤖</div>
              <div id="assistantMessage" style="font-size: 0.9rem;"></div>
            </div>
          `;
          document.body.appendChild(assistant);
        }
        
        document.getElementById('assistantMessage').textContent = message;
        assistant.style.transform = 'translateX(0)';
        
        // إخفاء تلقائي بعد 5 ثواني
        setTimeout(() => {
          assistant.style.transform = 'translateX(100%)';
        }, 5000);
      }

      // نظام النسخ الاحتياطي
      function backupData() {
        const backup = {
          count: count,
          dailyCount: dailyCount,
          weeklyCount: weeklyCount,
          totalCount: totalCount,
          userLevel: userLevel,
          userPoints: userPoints,
          achievements: achievements,
          history: history,
          timestamp: new Date().toISOString()
        };
        
        localStorage.setItem("tasbihBackup", JSON.stringify(backup));
        showNotification("💾 تم حفظ نسخة احتياطية", 2000);
      }

      function restoreBackup() {
        const backup = localStorage.getItem("tasbihBackup");
        if (backup) {
          const data = JSON.parse(backup);
          
          count = data.count || 0;
          dailyCount = data.dailyCount || 0;
          weeklyCount = data.weeklyCount || 0;
          totalCount = data.totalCount || 0;
          userLevel = data.userLevel || 1;
          userPoints = data.userPoints || 0;
          achievements = data.achievements || [];
          history = data.history || [];
          
          saveUserData();
          updateUI();
          showNotification("🔄 تم استعادة النسخة الاحتياطية", 2000);
        } else {
          showNotification("❌ لا توجد نسخة احتياطية", 2000);
        }
      }

      // إضافة أزرار النسخ الاحتياطي
      function addBackupButtons() {
        const backupBtn = document.createElement('button');
        backupBtn.innerHTML = '<i class="fas fa-save"></i> نسخة';
        backupBtn.className = 'btn btn-accent';
        backupBtn.style.margin = '5px';
        backupBtn.onclick = backupData;
        
        const restoreBtn = document.createElement('button');
        restoreBtn.innerHTML = '<i class="fas fa-undo"></i> استعادة';
        restoreBtn.className = 'btn btn-secondary';
        restoreBtn.style.margin = '5px';
        restoreBtn.onclick = restoreBackup;
        
        const buttonsContainer = document.querySelector('.buttons-grid');
        buttonsContainer.appendChild(backupBtn);
        buttonsContainer.appendChild(restoreBtn);
      }

      // تهيئة التطبيق النهائية
      function initialize() {
        initializeApp();
        addBackupButtons();
        initializeAssistant();
        checkSeasonalChallenges();
        
        // عرض رسالة ترحيب
        setTimeout(() => {
          showNotification("مرحباً بك في السبحة الإلكترونية المتطورة! 🎉", 3000);
          
          // التحقق من الإنجازات أول مرة
          checkAchievements();
          updateAchievementsDisplay();
        }, 1000);
      }

      // بدء التشغيل
      document.addEventListener("DOMContentLoaded", initialize);
      // الوضع الداكن المحسّن
function toggleDarkMode() {
  const isDark = document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", isDark);
  
  // تحديث أيقونة الوضع الداكن
  const darkModeBtn = document.getElementById("darkModeBtn");
  if (darkModeBtn) {
    darkModeBtn.innerHTML = isDark ? 
      '<i class="fas fa-sun"></i> فاتح' : 
      '<i class="fas fa-moon"></i> داكن';
  }
  
  showNotification(
    isDark ? 
    "🌙 تم تفعيل الوضع الداكن" : "☀️ تم تفعيل الوضع الفاتح", 
    2000
  );
}

// زر المساعد الذكي
function addAssistantButton() {
  const assistantBtn = document.createElement('button');
  assistantBtn.className = 'btn btn-success';
  assistantBtn.innerHTML = '<i class="fas fa-robot"></i> مساعد';
  assistantBtn.onclick = showAssistantPanel;
  assistantBtn.style.margin = '5px';
  
  const buttonsContainer = document.querySelector('.buttons-grid');
  buttonsContainer.appendChild(assistantBtn);
}

// لوحة المساعد
function showAssistantPanel() {
  // إنشاء لوحة المساعد إذا لم تكن موجودة
  let panel = document.getElementById('assistantPanel');
  if (!panel) {
    panel = document.createElement('div');
    panel.id = 'assistantPanel';
    panel.style.position = 'fixed';
    panel.style.bottom = '20px';
    panel.style.right = '20px';
    panel.style.background = 'linear-gradient(135deg, var(--primary), var(--accent))';
    panel.style.color = 'white';
    panel.style.padding = '20px';
    panel.style.borderRadius = '15px';
    panel.style.boxShadow = '0 10px 40px rgba(0,0,0,0.3)';
    panel.style.zIndex = '1000';
    panel.style.maxWidth = '350px';
    panel.style.maxHeight = '400px';
    panel.style.overflowY = 'auto';
    panel.style.display = 'none';
    
    panel.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0; font-size: 1.2rem;">🤖 المساعد الذكي</h3>
        <button onclick="closeAssistantPanel()" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="assistantMessages" style="margin-bottom: 15px;"></div>
      <button onclick="askAssistant()" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; cursor: pointer;">
        <i class="fas fa-question"></i> اطلب نصيحة
      </button>
    `;
    
    document.body.appendChild(panel);
  }
  
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function closeAssistantPanel() {
  const panel = document.getElementById('assistantPanel');
  if (panel) {
    panel.style.display = 'none';
  }
}

function askAssistant() {
  const tips = [
    "💡 جرب التسبيح بعد صلاة الفجر لأجر مضاعف",
    "🌅 أفضل الأوقات: الصباح الباكر وقبل الغروب",
    "🎯 حدد هدفاً يومياً وحاول تحقيقه قبل المغرب",
    "⭐ الاستمرارية في التسبيح تزيد البركة",
    "🤲 ادع الله بعد كل 33 تسبيحة فهو وقت مستجاب",
    "📿 غير أنواع التسبيح للحفاظ على التركيز",
    "🌙 في الليل يكون الذهن صافياً والأجر أكبر",
    "🙏 التسبيح يطهر القلب ويبعد الوساوس",
    "🚀 أنت على الطريق الصحيح! استمر في التقدم",
    "🏆 كل تسبيحة تقربك من الله وتزيد حسناتك"
  ];
  
  const randomTip = tips[Math.floor(Math.random() * tips.length)];
  addAssistantMessage(randomTip);
}

function addAssistantMessage(message) {
  const messagesContainer = document.getElementById('assistantMessages');
  if (messagesContainer) {
    const messageElement = document.createElement('div');
    messageElement.style.background = 'rgba(255,255,255,0.1)';
    messageElement.style.padding = '12px';
    messageElement.style.borderRadius = '8px';
    messageElement.style.marginBottom = '10px';
    messageElement.style.fontSize = '0.9rem';
    messageElement.textContent = message;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

// في دالة initialize، أضف:
function initialize() {
  initializeApp();
  addBackupButtons();
  addAssistantButton(); // إضافة زر المساعد
  initializeAssistant();
  checkSeasonalChallenges();
  
  // تحميل وضع الداكن إذا كان مفعلاً
  const isDarkMode = localStorage.getItem("darkMode") === "true";
  if (isDarkMode) {
    document.body.classList.add("dark");
    // تحديث أيقونة الزر
    const darkModeBtn = document.getElementById("darkModeBtn");
    if (darkModeBtn) {
      darkModeBtn.innerHTML = '<i class="fas fa-sun"></i> فاتح';
    }
  }
  
  showNotification("مرحباً بك في السبحة الإلكترونية المتطورة! 🎉", 3000);
}
// إصلاح المشكلة 1: إظهار الواجهة الرئيسية بدلاً من وضع الكينوي
function ensureMainInterface() {
  const kineticMode = document.getElementById("kineticMode");
  if (kineticMode) {
    kineticMode.style.display = "none";
  }
  kineticActive = false;
  
  // إظهار كل اللوحات الرئيسية
  document.body.style.overflow = "auto";
}

// إصلاح المشكلة 2: زر تبديل الأوضاع الداكن/فاتح
function addDarkModeToggle() {
  // البحث عن الزر الموجود أو إنشاؤه
  let darkModeBtn = document.getElementById("darkModeBtn");
  
  if (!darkModeBtn) {
    // إنشاء زر جديد إذا لم يكن موجوداً
    darkModeBtn = document.createElement('button');
    darkModeBtn.id = 'darkModeBtn';
    darkModeBtn.className = 'btn btn-secondary';
    darkModeBtn.innerHTML = '<i class="fas fa-moon"></i> داكن';
    darkModeBtn.onclick = toggleDarkMode;
    
    // إضافة الزر إلى الشبكة
    const buttonsContainer = document.querySelector('.buttons-grid');
    if (buttonsContainer) {
      buttonsContainer.appendChild(darkModeBtn);
    }
  }
  
  // تحديث أيقونة الزر حسب الوضع الحالي
  const isDark = document.body.classList.contains("dark");
  darkModeBtn.innerHTML = isDark ? 
    '<i class="fas fa-sun"></i> فاتح' : 
    '<i class="fas fa-moon"></i> داكن';
}

// إصلاح المشكلة 3: اللغة الإنجليزية
function updateLanguageSettings() {
  const select = document.getElementById("language");
  if (!select) return;
  
  language = select.value;
  localStorage.setItem("language", language);
  
  // تحديث جميع نصوص الواجهة
  updateAllTexts();
  
  showNotification(
    language === "ar" ? 
    "🇸🇦 تم التغيير إلى العربية" : "🇺🇸 Changed to English", 
    2000
  );
}

function updateAllTexts() {
  // تحديث النصوص حسب اللغة
  const elementsToUpdate = {
    'resetBtn': translations[language].reset,
    'soundBtn': soundOn ? translations[language].soundOn : translations[language].soundOff,
    'kineticBtn': translations[language].kinetic,
    'achievementsBtn': translations[language].achievements,
    'settingsBtn': translations[language].settings,
    'themeBtn': translations[language].theme
  };
  
  // تحديث نصوص الأزرار
  Object.keys(elementsToUpdate).forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      const icon = element.querySelector('i')?.outerHTML || '';
      element.innerHTML = icon + ' ' + elementsToUpdate[id];
    }
  });
  
  // تحديث الإحصائيات
  updateStatsText();
  
  // تحديث العنوان
  const title = document.querySelector('h1');
  if (title) {
    title.textContent = translations[language].title;
  }
}

function updateStatsText() {
  const statElements = [
    { id: 'dailyCount', label: 'daily' },
    { id: 'weeklyCount', label: 'weekly' },
    { id: 'totalCount', label: 'total' },
    { id: 'elapsedTime', label: 'time' }
  ];
  
  statElements.forEach(stat => {
    const container = document.querySelector(`.stat-card:nth-child(${statElements.indexOf(stat) + 1}) .stat-label`);
    if (container) {
      container.textContent = translations[language][stat.label];
    }
  });
  
  // تحديث مستوى المستخدم
  const levelBadge = document.querySelector('.level-badge');
  if (levelBadge) {
    levelBadge.innerHTML = `
      <i class="fas fa-star"></i>
      <span>${translations[language].level}: <span id="userLevel">${userLevel}</span></span>
      <span>•</span>
      <span>${translations[language].points}: <span id="userPoints">${userPoints}</span></span>
    `;
  }
}

// تحميل اللغة المحفوظة
function loadLanguageSetting() {
  const savedLanguage = localStorage.getItem("language");
  if (savedLanguage) {
    language = savedLanguage;
    const select = document.getElementById("language");
    if (select) {
      select.value = language;
    }
  }
}

// تهيئة محسنة
function initializeFixed() {
  ensureMainInterface(); // التأكد من إظهار الواجهة الرئيسية
  loadLanguageSetting(); // تحميل إعدادات اللغة
  initializeApp(); // التهيئة الأساسية
  addDarkModeToggle(); // إضافة زر الوضع الداكن
  checkSeasonalChallenges(); // التحديات الموسمية
  updateAllTexts(); // تحديث النصوص حسب اللغة
  
  // رسالة ترحيب
  setTimeout(() => {
    showNotification(
      language === "ar" ? 
      "مرحباً بك في السبحة الإلكترونية المتطورة! 🎉" : 
      "Welcome to Advanced Digital Tasbih! 🎉", 
      3000
    );
  }, 1000);
}

// استبدال دالة التهيئة الأصلية
document.addEventListener("DOMContentLoaded", initializeFixed);
// 1. نظام التعلم الآلي الذكي
const mlSystem = {
  userPatterns: [],
  peakTimes: [],
  suggestions: [],
  
  analyzePatterns() {
    // تحليل أنماط التسبيح
    const now = new Date();
    const hour = now.getHours();
    const day = now.getDay();
    
    // تسجيل نمط المستخدم
    this.userPatterns.push({
      timestamp: now,
      hour: hour,
      day: day,
      count: count
    });
    
    // تحليل أوقات الذروة
    this.updatePeakTimes(hour);
    
    // توليد نصائح ذكية
    this.generateSuggestions();
    
    // حفظ البيانات
    this.saveData();
  },
  
  updatePeakTimes(currentHour) {
    if (!this.peakTimes[currentHour]) {
      this.peakTimes[currentHour] = 0;
    }
    this.peakTimes[currentHour]++;
  },
  
  generateSuggestions() {
    const suggestions = [
      `📊 أفضل أوقاتك: ${this.getBestTime()}`,
      `🎯 معدلك: ${Math.round(totalCount / 7)} يومياً`,
      `⭐ أنت أفضل من ${this.getPercentile()}% من المستخدمين`,
      `💡 جرب التسبيح ${this.getOptimalTime()}`
    ];
    
    this.suggestions = suggestions;
  },
  
  getBestTime() {
    const bestHour = this.peakTimes.indexOf(Math.max(...this.peakTimes.filter(Boolean)));
    return bestHour >= 0 ? `الساعة ${bestHour}:00` : 'لم تحدد بعد';
  },
  
  getPercentile() {
    return Math.min(95, Math.floor((totalCount / 500) * 100));
  },
  
  getOptimalTime() {
    const now = new Date();
    const nextOptimal = (now.getHours() + 3) % 24;
    return `بعد ${3} ساعات (∼${nextOptimal}:00)`;
  },
  
  saveData() {
    localStorage.setItem('mlData', JSON.stringify({
      patterns: this.userPatterns,
      peakTimes: this.peakTimes
    }));
  },
  
  loadData() {
    const saved = JSON.parse(localStorage.getItem('mlData') || '{}');
    this.userPatterns = saved.patterns || [];
    this.peakTimes = saved.peakTimes || [];
  },
  
  getSmartTip() {
    return this.suggestions[Math.floor(Math.random() * this.suggestions.length)];
  }
};

// 2. التكامل مع التقويم الهجري
const hijriCalendar = {
  currentDate: new Date(),
  
  getHijriDate() {
    const hijriMonths = ['محرم', 'صفر', 'ربيع الأول', 'ربيع الثاني', 'جمادى الأولى', 
                        'جمادى الآخرة', 'رجب', 'شعبان', 'رمضان', 'شوال', 'ذو القعدة', 'ذو الحجة'];
    
    // محاكاة تاريخ هجري (يمكن استبداله بـ API حقيقي)
    const approxHijriYear = 1445 + Math.floor((this.currentDate.getFullYear() - 2023) * 0.97);
    const hijriMonth = hijriMonths[this.currentDate.getMonth()];
    const hijriDay = this.currentDate.getDate() % 30;
    
    return `${hijriDay} ${hijriMonth} ${approxHijriYear} هـ`;
  },
  
  getSpecialDays() {
    const specialDays = {
      '15': 'منتصف الشهر - أيام بيض',
      '27': 'ليلة مباركة',
      '13': 'أيام البيض',
      '14': 'أيام البيض',
      'Friday': 'يوم الجمعة المبارك'
    };
    
    return specialDays;
  },
  
  checkSpecialDay() {
    const day = this.currentDate.getDate().toString();
    const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][this.currentDate.getDay()];
    
    const specialDays = this.getSpecialDays();
    return specialDays[day] || specialDays[dayOfWeek];
  },
  
  showHijriNotification() {
    const specialDay = this.checkSpecialDay();
    if (specialDay) {
      showNotification(`📅 ${specialDay} - اليوم يوم مبارك!`, 5000);
    }
  }
};

// 3. نظام الكنوز والأسرار
const treasureSystem = {
  treasures: [
    { id: 1, name: 'كنز البداية', condition: () => totalCount >= 10, unlocked: false, reward: 20 },
    { id: 2, name: 'كنز الانتظام', condition: () => dailyCount >= 3, unlocked: false, reward: 15 },
    { id: 3, name: 'كنز الصباح', condition: () => new Date().getHours() < 10 && count > 0, unlocked: false, reward: 25 },
    { id: 4, name: 'كنز الليل', condition: () => new Date().getHours() > 20 && count > 0, unlocked: false, reward: 25 },
    { id: 5, name: 'كنز المثابرة', condition: () => weeklyCount >= 100, unlocked: false, reward: 50 }
  ],
  
  checkTreasures() {
    this.treasures.forEach(treasure => {
      if (!treasure.unlocked && treasure.condition()) {
        this.unlockTreasure(treasure);
      }
    });
  },
  
  unlockTreasure(treasure) {
    treasure.unlocked = true;
    userPoints += treasure.reward;
    
    showNotification(`🎁 وجدت كنز: ${treasure.name}! +${treasure.reward} نقطة`, 4000);
    createConfetti();
    
    this.saveTreasures();
  },
  
  saveTreasures() {
    localStorage.setItem('treasures', JSON.stringify(this.treasures));
  },
  
  loadTreasures() {
    const saved = JSON.parse(localStorage.getItem('treasures') || '[]');
    if (saved.length > 0) {
      this.treasures = saved;
    }
  }
};

// 4. النظام الموسمي الديناميكي
const seasonalSystem = {
  seasons: {
    ramadan: { start: [4, 1], end: [4, 30], active: false, multiplier: 2 },
    hajj: { start: [6, 1], end: [6, 10], active: false, multiplier: 1.5 },
    muharram: { start: [1, 1], end: [1, 10], active: false, multiplier: 1.3 }
  },
  
  checkSeasons() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const currentDay = now.getDate();
    
    Object.keys(this.seasons).forEach(season => {
      const s = this.seasons[season];
      s.active = this.isDateInRange(currentMonth, currentDay, s.start, s.end);
      
      if (s.active && !s.notified) {
        showNotification(`🌙 ${this.getSeasonName(season)} - الأجر مضاعف!`, 5000);
        s.notified = true;
      }
    });
  },
  
  isDateInRange(month, day, start, end) {
    return month === start[0] && day >= start[1] && day <= end[1];
  },
  
  getSeasonName(season) {
    const names = {
      ramadan: 'شهر رمضان المبارك',
      hajj: 'أيام الحج',
      muharram: 'شهر المحرم'
    };
    return names[season] || season;
  },
  
  getCurrentMultiplier() {
    const activeSeason = Object.values(this.seasons).find(s => s.active);
    return activeSeason ? activeSeason.multiplier : 1;
  }
};

// 5. إعادة تعيين كل القيم
function addResetAllOption() {
  const resetBtn = document.createElement('button');
  resetBtn.className = 'btn btn-danger';
  resetBtn.innerHTML = '<i class="fas fa-trash"></i> إعادة الضبط';
  resetBtn.onclick = confirmResetAll;
  resetBtn.style.margin = '5px';
  
  const settingsPanel = document.getElementById('settingsPanel');
  if (settingsPanel) {
    settingsPanel.querySelector('.settings-grid').appendChild(resetBtn);
  }
}

function confirmResetAll() {
  if (confirm(language === 'ar' ? 
      '⚠️ هل أنت متأكد من إعادة ضبط كل البيانات؟ لا يمكن التراجع عن هذا الإجراء!' :
      '⚠️ Are you sure you want to reset all data? This cannot be undone!')) {
    resetAllData();
  }
}

function resetAllData() {
  // مسح كل البيانات
  localStorage.clear();
  
  // إعادة تعيين المتغيرات
  count = dailyCount = weeklyCount = totalCount = userPoints = 0;
  userLevel = 1;
  achievements = achievementsData.map(ach => ({...ach, unlocked: false}));
  
  // إعادة التهيئة
  saveUserData();
  updateUI();
  
  showNotification('🔄 تم إعادة ضبط كل البيانات بنجاح', 3000);
}
// زر إعادة الضبط الكامل - يعمل مباشرة
function addSimpleResetButton() {
  // إنشاء زر بسيط واضح
  const resetBtn = document.createElement('button');
  resetBtn.className = 'btn';
  resetBtn.style.background = 'linear-gradient(135deg, #ff4757, #ff3838)';
  resetBtn.style.color = 'white';
  resetBtn.style.margin = '10px';
  resetBtn.style.padding = '15px 25px';
  resetBtn.style.border = 'none';
  resetBtn.style.borderRadius = '10px';
  resetBtn.style.cursor = 'pointer';
  resetBtn.style.fontWeight = 'bold';
  resetBtn.innerHTML = '<i class="fas fa-trash"></i> إعادة ضبط الكل';
  
  resetBtn.onclick = function() {
    if (confirm('⚠️ هل تريد حذف كل البيانات؟ لا يمكن التراجع!')) {
      localStorage.clear();
      location.reload(); // إعادة تحميل الصفحة
    }
  };
  
  // إضافة الزر لوحة الإعدادات
  const settingsPanel = document.getElementById('settingsPanel');
  if (settingsPanel) {
    settingsPanel.appendChild(resetBtn);
  }
}
  
  
  

// تهيئة بسيطة تعمل مباشرة
function simpleInit() {
  // إضافة زر الإعادة بعد ثواني
  setTimeout(() => {
    addSimpleResetButton();
    addSimpleGlassTheme();
  }, 1000);
}

// تشغيل التهيئة البسيطة
document.addEventListener('DOMContentLoaded', simpleInit);
// نظام الأسابيع المنفصل - يزيد كل 7 أيام فقط
let weekCount = parseInt(localStorage.getItem('weekCount')) || 0;
let lastIncrementDate = localStorage.getItem('lastIncrementDate') || '';

function checkWeeklyIncrement() {
  const today = new Date().toDateString();
  
  // إذا كان تاريخ جديد ولم يكن آخر increment اليوم
  if (today !== lastIncrementDate) {
    const lastDate = lastIncrementDate ? new Date(lastIncrementDate) : new Date();
    const timeDiff = new Date() - lastDate;
    const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
    
    // كل 7 أيام نزيد العدد
    if (daysDiff >= 7) {
      weekCount++;
      lastIncrementDate = today;
      localStorage.setItem('weekCount', weekCount);
      localStorage.setItem('lastIncrementDate', lastIncrementDate);
      showNotification(`📅 تم زيادة العدد الأسبوعي: ${weekCount}`, 3000);
    }
  }
}

// منع التكبير بشكل نهائي وقاطع
function enforceStrictNoZoom() {
  // إضافة viewport صارم
  const viewport = document.createElement('meta');
  viewport.name = 'viewport';
  viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimum-scale=1.0';
  document.head.appendChild(viewport);
ستمعين
  document.addEventListener('touchstart', preventZoom, { passive: false });
  document.addEventListener('touchmove', preventZoom, { passive: false });
  document.addEventListener('touchend', preventZoom, { passive: false });
  document.addEventListener('gesturestart', function(e) {
    e.preventDefault();
    return false;
  });
  document.addEventListener('gesturechange', function(e) {
    e.preventDefault();
    return false;
  });
  document.addEventListener('wheel', function(e) {
    if (e.ctrlKey) {
      e.preventDefault();
      return false;
    }
  }, { passive: false });

  // منع double tap
  let lastTouchTime = 0;
  document.addEventListener('touchend', function(e) {
    const currentTime = new Date().getTime();
    if (currentTime - lastTouchTime < 300) {
      e.preventDefault();
      return false;
    }
    lastTouchTime = currentTime;
  }, { passive: false });
}

// تعديل دالة handleCircleClick لفصل العد
const originalHandleCircleClick = handleCircleClick;
handleCircleClick = function() {
  count++;
  dailyCount++;
  totalCount++;
  
  userPoints++;
  saveUserData();
  updateUI();
  
  if (soundOn) {
    playBeep();
  }
  
  if (count % limit === 0 && count > 0) {
    handleCircleCompletion();
  }
  
  checkAchievements();
  updateLevel();
  
  // التحقق من زيادة العدد الأسبوعي (منفصل تماماً)
  checkWeeklyIncrement();
};

// تحديث واجهة المستخدم لعرض العد الأسبوعي المنفصل
function updateUIWithWeekly() {
  updateUI();
  const weeklyElement = document.getElementById('weeklyCount');
  if (weeklyElement) {
    weeklyElement.textContent = weekCount;
  }
}

// تهيئة النظام
function initSeparateWeeklySystem() {
  // تحميل البيانات
  weekCount = parseInt(localStorage.getItem('weekCount')) || 0;
  lastIncrementDate = localStorage.getItem('lastIncrementDate') || '';
  
  // تطبيق منع الزوم الصارم
  enforceStrictNoZoom();
  
  // التحقق اليومي
  setInterval(checkWeeklyIncrement, 3600000); // كل ساعة
}


// تحديث دالة الحفظ
const originalSaveUserData = saveUserData;
saveUserData = function() {
  originalSaveUserData();
  localStorage.setItem('weekCount', weekCount);
  localStorage.setItem('lastIncrementDate', lastIncrementDate);
};
// منع التكبير بدون تقييد النقر على الدائرة
function preventZoomButAllowTasbih() {
  // منع التكبير على مستوى الصفحة
  const viewport = document.querySelector('meta[name="viewport"]') || document.createElement('meta');
  viewport.name = 'viewport';
  viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
  document.head.appendChild(viewport);

  // منع أحداث التكبير العامة
  const preventZoom = function(e) {
    if (e.touches.length > 1) {
      e.preventDefault();
    }
  };

  // تطبيق على document لكن استثناء الدائرة
  document.addEventListener('touchstart', function(e) {
    if (e.touches.length > 1 && !e.target.closest('#circle')) {
      e.preventDefault();
    }
  }, { passive: false });

  document.addEventListener('gesturestart', function(e) {
    if (!e.target.closest('#circle')) {
      e.preventDefault();
    }
  });

  // السماح باللمس على الدائرة فقط
  const circle = document.getElementById('circle');
  if (circle) {
    circle.style.touchAction = 'manipulation';
    circle.style.webkitUserSelect = 'none';
    circle.style.userSelect = 'none';
  }
}

// تهيئة سريعة للتسبيح
function initFastTasbih() {
  const circle = document.getElementById('circle');
  if (circle) {
    circle.onclick = function() {
      count++;
      dailyCount++;
      totalCount++;
      userPoints++;
      
      // تحديث فوري
      document.getElementById("countText").textContent = count;
      document.getElementById("dailyCount").textContent = dailyCount;
      document.getElementById("totalCount").textContent = totalCount;
      document.getElementById("userPoints").textContent = userPoints;
      
      // صوت سريع
      if (soundOn) {
        const beep = new AudioContext();
        const oscillator = beep.createOscillator();
        oscillator.connect(beep.destination);
        oscillator.start();
        oscillator.stop(beep.currentTime + 0.01);
      }
      
      // حفظ بيانات
      localStorage.setItem("count", count);
      localStorage.setItem("dailyCount", dailyCount);
      localStorage.setItem("totalCount", totalCount);
      localStorage.setItem("userPoints", userPoints);
    };
  }
}

// تشغيل كل شيء
document.addEventListener('DOMContentLoaded', function() {
  preventZoomButAllowTasbih();
  initFastTasbih();
  
  // تحميل البيانات
  count = parseInt(localStorage.getItem("count")) || 0;
  dailyCount = parseInt(localStorage.getItem("dailyCount")) || 0;
  totalCount = parseInt(localStorage.getItem("totalCount")) || 0;
  userPoints = parseInt(localStorage.getItem("userPoints")) || 0;
  
  // تحديث الواجهة
  document.getElementById("countText").textContent = count;
  document.getElementById("dailyCount").textContent = dailyCount;
  document.getElementById("totalCount").textContent = totalCount;
  document.getElementById("userPoints").textContent = userPoints;
});
// إصلاح الزيادة المزدوجة - إزالة event listeners المكررة
function fixDoubleIncrement() {
  const circle = document.getElementById('circle');
  if (!circle) return;
  
  // إزالة جميع event listeners القديمة
  const newCircle = circle.cloneNode(true);
  circle.parentNode.replaceChild(newCircle, circle);
  
  // إضافة event listener واحد فقط
  newCircle.addEventListener('click', handleTasbihClick, { once: false });
}

// دالة التسبيح الأساسية
function handleTasbihClick(e) {
  e.preventDefault();
  e.stopPropagation();
  e.stopImmediatePropagation();
  
  // زيادة العدادات مرة واحدة فقط
  count++;
  dailyCount++;
  totalCount++;
  userPoints++;
  
  // تحديث الواجهة فوراً
  updateDisplay();
  
  // صوت سريع
  if (soundOn) {
    playQuickBeep();
  }
  
  // حفظ البيانات
  saveData();
}

// تحديث العرض فقط
function updateDisplay() {
  const countText = document.getElementById("countText");
  const dailyCountElement = document.getElementById("dailyCount");
  const totalCountElement = document.getElementById("totalCount");
  const userPointsElement = document.getElementById("userPoints");
  
  if (countText) countText.textContent = count;
  if (dailyCountElement) dailyCountElement.textContent = dailyCount;
  if (totalCountElement) totalCountElement.textContent = totalCount;
  if (userPointsElement) userPointsElement.textContent = userPoints;
  
  // تحديث شريط التقدم
  updateProgress();
}

// صوت سريع جداً
function playQuickBeep() {
  try {
    if (typeof AudioContext !== 'undefined') {
      const context = new AudioContext();
      const oscillator = context.createOscillator();
      oscillator.connect(context.destination);
      oscillator.start();
      oscillator.stop(context.currentTime + 0.01);
    }
  } catch (error) {
    // تجاهل الأخطاء الصوتية
  }
}

// حفظ البيانات
function saveData() {
  localStorage.setItem("count", count);
  localStorage.setItem("dailyCount", dailyCount);
  localStorage.setItem("totalCount", totalCount);
  localStorage.setItem("userPoints", userPoints);
}

// تهيئة بسيطة
function simpleInit() {
  // تحميل البيانات
  count = parseInt(localStorage.getItem("count")) || 0;
  dailyCount = parseInt(localStorage.getItem("dailyCount")) || 0;
  totalCount = parseInt(localStorage.getItem("totalCount")) || 0;
  userPoints = parseInt(localStorage.getItem("userPoints")) || 0;
  
  // تحديث العرض
  updateDisplay();
  
  // إصلاح الزيادة المزدوجة
  setTimeout(fixDoubleIncrement, 100);
}

// تشغيل التهيئة
document.addEventListener('DOMContentLoaded', simpleInit);
// إضافة زر إعادة التعيين إلى لوحة الإعدادات
function addResetToSettings() {
  // الانتظار حتى تحميل لوحة الإعدادات
  const checkSettings = setInterval(() => {
    const settingsPanel = document.getElementById('settingsPanel');
    if (settingsPanel) {
      clearInterval(checkSettings);
      
      // إنشاء قسم إعادة التعيين
      const resetSection = document.createElement('div');
      resetSection.style.cssText = `
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid var(--border-color);
        text-align: center;
      `;
      
      resetSection.innerHTML = `
        <h4 style="color: var(--danger); margin-bottom: 15px;">
          <i class="fas fa-exclamation-triangle"></i> الإعدادات المتقدمة
        </h4>
        <button id="resetAllButton" style="
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, #ff4757, #ff3838);
          color: white;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          font-weight: bold;
          font-size: 16px;
          transition: all 0.3s ease;
        ">
          <i class="fas fa-trash"></i> إعادة تعيين كل البيانات
        </button>
        <p style="font-size: 12px; color: var(--text); opacity: 0.7; margin-top: 10px;">
          ⚠️ سيتم حذف جميع الإحصائيات والإنجازات ولا يمكن الاستعادة
        </p>
      `;
      
      // إضافة إلى لوحة الإعدادات
      settingsPanel.appendChild(resetSection);
      
      // إضافة event listener
      document.getElementById('resetAllButton').onclick = function() {
        if (confirm('⚠️ هل أنت متأكد من إعادة تعيين كل البيانات؟\n\nسيتم حذف:\n• جميع التسبيحات\n• الإحصائيات اليومية والأسبوعية\n• النقاط والمستويات\n• الإنجازات\n\nهذا الإجراء لا يمكن التراجع عنه!')) {
          resetAllData();
        }
      };
    }
  }, 100);
}

// دالة إعادة التعيين الكاملة
function resetAllData() {
  // قائمة بجميع مفاتيح localStorage التي يجب مسحها
  const keysToRemove = [
    'count', 'dailyCount', 'weeklyCount', 'totalCount',
    'userPoints', 'userLevel', 'tasbihDate', 'tasbihHistory',
    'achievements', 'currentTheme', 'soundOn', 'soundFreq',
    'language', 'limit', 'tasbihText', 'currentWeekNumber',
    'weekCount', 'lastIncrementDate', 'glassThemeActive'
  ];
  
  // مسح جميع البيانات
  keysToRemove.forEach(key => localStorage.removeItem(key));
  
  // إعادة تعيين جميع المتغيرات
  count = 0;
  dailyCount = 0;
  weeklyCount = 0;
  totalCount = 0;
  userPoints = 0;
  userLevel = 1;
  
  // تحديث الواجهة مباشرة
  updateAllDisplays();
  
  // إظهار رسالة نجاح
  showNotification('✅ تم إعادة تعيين جميع البيانات بنجاح', 3000);
  
  // إعادة تحميل الصفحة بعد ثانية
  setTimeout(() => location.reload(), 1000);
}

// تحديث جميع العناصر
function updateAllDisplays() {
  const elements = {
    'countText': count,
    'dailyCount': dailyCount,
    'weeklyCount': weeklyCount,
    'totalCount': totalCount,
    'userPoints': userPoints,
    'userLevel': userLevel
  };
  
  for (const [id, value] of Object.entries(elements)) {
    const element = document.getElementById(id);
    if (element) element.textContent = value;
  }
  
  // إعادة تعيين شريط التقدم
  const progressCircle = document.getElementById('progress');
  if (progressCircle) {
    progressCircle.style.strokeDashoffset = '565.48';
  }
}

// إشعار
function showNotification(message, duration) {
  const notification = document.createElement('div');
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    z-index: 1000;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, duration);
}

// تهيئة الزر عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
  // تحميل البيانات
  count = parseInt(localStorage.getItem("count")) || 0;
  dailyCount = parseInt(localStorage.getItem("dailyCount")) || 0;
  totalCount = parseInt(localStorage.getItem("totalCount")) || 0;
  userPoints = parseInt(localStorage.getItem("userPoints")) || 0;
  userLevel = parseInt(localStorage.getItem("userLevel")) || 1;
  
  // تحديث العرض
  updateAllDisplays();
  
  // إضافة زر الإعادة إلى الإعدادات
  addResetToSettings();
});
    </script>
    <div id="updateBox" style="display:none;position:fixed;bottom:20px;right:20px;
     background:#fff8c6;padding:15px;border:1px solid #f0c000;border-radius:10px;
     box-shadow:0 0 10px rgba(0,0,0,0.2);z-index:999;">
  <strong>📢 تحديث متوفر!</strong><br>
  <span id="updateMessage"></span><br><br>
  <a id="updateLink" href="#" target="_blank" style="color:#007bff;">🔄 تحميل التحديث</a>
</div>

<script>
fetch("sebha.txt")
  .then(res => res.text())
  .then(text => {
    const lines = text.split("\n");
    let remoteVersion = 0;
    let updateMessage = "";
    let updateLink = "#";

    for (const line of lines) {
      const [key, value] = line.split("=");
      if (key === "version") remoteVersion = parseFloat(value);
      if (key === "message") updateMessage = value;
      if (key === "link") updateLink = value;
    }

    const currentVersion = 1; // عدّل هذا حسب إصدارك الحالي

    if (remoteVersion > currentVersion) {
      document.getElementById("updateMessage").textContent = updateMessage;
      document.getElementById("updateLink").href = updateLink;
      document.getElementById("updateBox").style.display = "block";
    }
  });
</script>
  </body>
</html>
